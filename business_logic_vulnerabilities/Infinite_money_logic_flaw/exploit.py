from bs4 import BeautifulSoup
import requests
import re


#Variables
url = "https://0ab4001603bd53eb854447a900870052.web-security-academy.net"
creds = {'username' : 'wiener', 'password' : 'peter'}
s = requests.Session()


#Fonctions

def getSessionCookie(s, url, creds):
    url_login = url + "/login"
    creds['csrf'] = BeautifulSoup(s.get(url_login).text, 'html.parser').find('input', {'name': 'csrf'})['value']  #Get csrf token
    login = s.post(url_login, data=creds, allow_redirects=False).headers
    cookie_value = login['Set-Cookie'].split(';')[0].split('=')[1]  #Get cookie from headers
    return {'session' : cookie_value}


def getCredit(s, url, cookie):
    url_account = url + "my-url_account?id=wiener"
    credit_text = BeautifulSoup(s.get(url, cookies=cookie).text, 'html.parser').find('strong').text
    credit = float(re.search(r'\d+\.\d+', credit_text).group()) #Search int in <strong> balise
    return credit

def getGiftsCard(s, url, cookie, credit):
    url_gift = url + "/cart"
    nb_gift_card = int(credit // 10) #Get maximum giftcard to buy with X$
    datas = {'productId' : 2, 'quantity' : nb_gift_card, 'redir' : 'PRODUCT'}



#Main
def main():
    cookie = getSessionCookie(s, url, creds)
    credit = getCredit(s, url, cookie)
    getGiftsCard(s, url, cookie, credit)


if __name__ == "__main__":
    main()
